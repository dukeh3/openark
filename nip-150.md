## OpenARK Templates

These templates define the structure for HTLC operations within the OpenARK protocol. Templates are referenced via tags in `vtxo_spend_request` messages.

### HTLC_Offer

Used when proposing an HTLC payment. The sender creates a conditional output that can be claimed by the recipient if they reveal the preimage.

Keys: A = sender pubkey, B = recipient pubkey, S = ASP.
Locked with script: B + H(P) + ( dT=10 | S ) | A + ( T=100 | B ) + ( dt=5 | S ) 

Six scenarios:
1. Success, in ARK. In this case B presents H(P), and S verifies it; value is spendable by B.
2. Return, in ARK. In this case B agrees to return the funds to A, and S verifies it; value is spendable by A.
3. Timeout, in ARK. In this case Block T is passed on-chain, and S verifies it; value is spendable by A.
4. Success, on-chain. In this case B presents H(P) and waits for dT blocks; value is spendable by B.
5. Return, on-chain. In this case B agrees to return the funds to A. A has to wait for dt blocks; value is spendable by A.
6. Timeout, on-chain. In this case Block T is passed on-chain. A has to wait for dt blocks; value is spendable by A.

The dt is there to make sure that any path signed by S has precedence over unilateral exit. 

Scenarios that need to be handled:

1. HTLS is the start of a chain, with a timeout of 120 blocks, that decreases by 20 blocks per hop.

   1. Success, in ARK. In this case B presents H(P), and S verifies it; value is spendable by B in ARK.
   2. Return, in ARK. In this case B agrees to return the funds to A, and S verifies it; value is spendable by A.
   3. Timeout, in ARK. In this case Block T is passed on-chain, and S verifies it; value is spendable by A.
   
   4. Success, on-chain. In this case B presents H(P) and waits for dT blocks; value is spendable by B.
   5. Return, on-chain. In this case B agrees to return the funds to A. A has to wait for dt blocks; value is spendable by A.
   6. Timeout, on-chain. In this case Block T is passed on-chain. A has to wait for dt blocks; value is spendable by A.

2. HTLS is in the middle of a chain, with a timeout of 120 blocks, that decreases by 20 blocks per hop.

   1. He has sent out a request that will return in 20 blocks. His own timeout is 40 blocks. At 20 he requests a return, S refuses. 
      - He has to make a unilateral exit. Forcing the block on-chain, where he has to wait for 10 blocks, to redeem funds. 
      - His funds are safe because his timelock is shorter than B.
      - He will never get H(P) so his incoming transaction is irrelevant.
   2. He receives the preimage at block 20. His funds are therefore transferred down the chain. So at 20 he claims the funds upstream, S refuses.
      - He now has to force the block on-chain. Where he has to wait for 15 blocks to redeem funds, so he has five blocks to claim the funds.
   
   3. He receives the preimage at block 40. His funds are therefore transferred down the chain. 40 is alse cut off time for the ARK.
      - He requests a transfer. Signs the signoff transaction. S waits to deposit the root. 
      - He does a unilateral exit at 45. He now has to wait for 10 blocks to redeem funds. S has the redeem transaction.
      - S deposits the root at 44. Activating the root, and redeems the funds.
      - He does a unilateral exit on the new tree. The new HTLC is now on-chain, and he is timelocked for 10 blocks. 
      - He redeems his funds at 55, well ahead of the timeout at 80. 

3. HTLS is the end of a chain, with a timeout of 20 blocks.






**Parameters:**
- `hash`: The hash H(P) that locks the funds
- `amount`: The amount in satoshis being offered
- `timeout_block`: Block height after which the offer expires
- `sender_pubkey`: Public key of the HTLC creator
- `recipient_pubkey`: Public key of the intended recipient

**Output Conditions:**
1. **Success Path**: Recipient can claim with signature + preimage P where H(P) matches hash
2. **Timeout Path**: Sender can reclaim after timeout_block with signature

### HTLC_Success

Used when claiming an HTLC by revealing the preimage. This template references a prior HTLC_Offer and provides the preimage to unlock funds.

**Parameters:**
- `htlc_offer_id`: Reference to the original HTLC_Offer transaction
- `preimage`: The secret P such that H(P) matches the offer's hash
- `recipient_pubkey`: Public key claiming the funds

**Requirements:**
- Must reference a valid, unexpired HTLC_Offer
- Preimage must hash to the HTLC_Offer's hash value
- Must be signed by the recipient

### HTLC_Timeout

Used when reclaiming funds from an expired HTLC. The original sender can recover their funds after the timeout block has been mined.

**Parameters:**
- `htlc_offer_id`: Reference to the original HTLC_Offer transaction
- `sender_pubkey`: Public key reclaiming the funds

**Requirements:**
- Must reference a valid HTLC_Offer
- Current block height must be >= timeout_block from the offer
- Must be signed by the original sender
- HTLC must not have been claimed via HTLC_Success

## Message format

All OpenARK protocol messages are Nostr events with:
1. kind: 150
2. tags: include ["t","<message_type>"] to identify the message type (mandatory)
3. content: message-specific payload (JSON or base64 as described below)

## Round message types

### new_round_initiate
Issued by the Ark Service Provider to announce a new round and its parameters (round_id, timeouts, relay, etc).
parameters:
- close_block: the block that triggers the round closure
- end_block: the block where the round terminates unilaterally

### new_round_join
Issued by a User to declare onboarding, offboarding, and transfer intentions for the round.
- list of outputs to onboard. (txid:pos)
- list of outputs to offboard. (output)
- address_of_last_resort: the address to which funds will be offboarded if the user misses the next round.
- user key, the keyset that will be used by the user in this round.
- agent key, the keyset that will be used by the agent in this round.

### new_round_vtxo_tree_proposal
Issued by the Ark Service Provider to propose the VTXO tree and all related transactions for signing.
- vtxo_tree: a JSON object representing the VTXO tree and associated transactions
- forfeit_tree
- recycle_transaction

### new_round_vtxo_tree_accept
Issued by Users to return signatures for the proposed VTXO tree.
- vtxo_tree_signatures

### new_round_prepare_start
Issued by the Ark Service Provider to request signatures for funding, forfeit, and recycle transactions, and to bind the new round root to the tree.

### new_round_start_prepared
Issued by Users to provide the requested funding/forfeit/recycle signatures and confirm acceptance of the tree and round root.
content:
- funding_signatures
- forfeit_signatures
- recycle_signature

### new_round_start
Issued by the Ark Service Provider once the root is deposited and the round officially starts.
- round_txid

### round_closed
Issued by the Ark Service Provider to signal a round has closed and to link it to a successor round.

### recycle_accept
Issued by a User who missed the round to sign the recycle transaction.
- recycle_signature

## Transaction messages

### vtxo_spend_request
Issued by the User who wishes to create a new transaction.
content: Base64-encoded PSBT, including signatures for incoming transactions.


    1. Tags all the outputs that are spent.
    2. Tags all the transactions that are spent.
    3. Tags all the signers that are requested to contribute.
    4. Tags all the potential beneficiaries. 
    5. Tags the template


### vtxo_spend_confirmed

nostr_id: 1502
content: Base64-encoded PSBT, including the additional signature this party provides.

Issued by co-signers who need to contribute to the transaction.

### vtxo_spend_complete

nostr_id: 1503
content: Base64-encoded final transaction.

Issued by the Ark Service Provider, contains the new transaction.

    1. Tags the txid of the new transaction.
    2. Tags to vtxo_spend_request.

### vtxo_spend_recall_request
nostr_id: 1504
Issued by a requester to cancel a previously submitted vtxo_spend_request.

### vtxo_spend_recalled
nostr_id: 1505
Issued by the Ark Service Provider, confirming that the vtxo_spend_request is to be considered recalled, and will never be completed.

    1. Tags to vtxo_spend_request.

### Code for Ark Service Provider

Only reactive, when you are tagged in a vtxo_spend_request you subscribe to the thread. You check if the current thread has enough information to complete the transaction. IE, you go over all of the inputs that are being spent and check:
1. Verify that the input is open for spending.
2. Check that all the signatures and other attributes are there.

If so, then you complete it, this means mark all the inputs as spent. Then send out the complete message and then unsubscribe from the thread.

If a recall request is received, mark the request as recalled. Issue a vtxo_spend_recalled, and unsubscribe from the thread.   
