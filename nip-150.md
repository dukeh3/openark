## OpenARK Templates

### HTLC_Offer

### HTLC_Success

### HTLC_Timeout

## Message format

All OpenARK protocol messages are Nostr events with:
1. kind: 150
2. tags: include ["t","<message_type>"] to identify the message type (mandatory)
3. content: message-specific payload (JSON or base64 as described below)

## Round message types

### new_round_initiate
Issued by the Ark Service Provider to announce a new round and its parameters (round_id, timeouts, relay, etc).
parameters:
- close_block: the block that triggers the round closure
- end_block: the block where the round terminates uniality

### new_round_join
Issued by a User to declare onboarding, offboarding, and transfer intentions for the round.
- list of outputs to onboard. (txid:pos)
- list of outputs to offboard. (output)
- address_of_last_resort: the address to which funds will be offboarded if the user misses the next round.

### new_round_vtxo_tree_proposal
Issued by the Ark Service Provider to propose the VTXO tree and all related transactions for signing.
- vtxo_tree: a JSON object representing the VTXO tree and associated transactions
- forfeit_tree
- recycle_transaction

### new_round_vtxo_tree_accept
Issued by Users to return signatures for the proposed VTXO tree.
- vtxo_tree_signatures

### new_round_prepare_start
Issued by the Ark Service Provider to request signatures for funding, forfeit, and recycle transactions, and to bind the new round root to the tree.

### new_round_start_prepared
Issued by Users to provide the requested funding/forfeit/recycle signatures and confirm acceptance of the tree and round root.
content:
- funding_signatures
- forfeit_signatures
- recycle_signature

### new_round_start
Issued by the Ark Service Provider once the root is deposited and the round officially starts.
- round_txid

### round_closed
Issued by the Ark Service Provider to signal a round has closed and to link it to a successor round.

### recycle_accept
Issued by a User who missed the round to sign the recycle transaction.
- recycle_signature

## Transaction messages

### vtxo_spend_request
Issued by the User who wishes to create a new transaction.
content: Base64-encoded PSBT, including signatures for incoming transactions.


    1. Tags all the outputs that are spent.
    2. Tags all the transactions that are spent.
    3. Tags all the signers that are requested to contribute.
    4. Tags all the potential beneficiaries. 
    5. Tags the template


### vtxo_spend_confirmed

nostr_id: 1502
content: Base64-encoded PSBT, including the additional signature this party provides.

Issued by co-signers who need to contribute to the transaction.

### vtxo_spend_complete

nostr_id: 1503
content: Base64-encoded final transaction.

Issued by the Ark Service Provider, contains the new transaction.

    1. Tags the txid of the new transaction.
    2. Tags to vtxo_spend_request.

### vtxo_spend_recall_request
nostr_id: 1504
Issued by a requester to cancel a previously submitted vtxo_spend_request.

### vtxo_spend_recalled
nostr_id: 1505
Issued by the Ark Service Provider, confirming that the vtxo_spend_request is to be considered recalled, and will never be completed.

    1. Tags to vtxo_spend_request.

### Code for Ark Service Provider

Only reactive, when you are tagged in a vtxo_spend_request you subscribe to the thread. You check if the current thread has enough information to complete the transaction. IE, you go over all of the inputs that are beeing spent and check:
1. Verify that the input is open for spending.
2. Check that all the signatures and other attributes are there.

If so, then you complete it, this means mark all the inputs as spent. Then send out the complete message and then unsubscribe from the thread.

If a recall request is received, mark the request as recalled. Issue a vtxo_spend_recalled, and unsubscribe from the thread.   
